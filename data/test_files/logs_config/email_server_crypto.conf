# Email Server Cryptographic Configuration
# Server: Postfix + Dovecot
# Security Profile: High Security with Legacy Support
# Updated: 2025-01-12

[SMTP_TLS_Configuration]
# Outbound SMTP TLS
smtp_tls_security_level = may
smtp_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_ciphers = high
smtp_tls_exclude_ciphers = aNULL, eNULL, EXPORT, DES, RC4, MD5, PSK, aECDH, EDH-DSS-DES-CBC3-SHA, EDH-RSA-DES-CBC3-SHA, KRB5-DES, CBC3-SHA

smtp_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtp_tls_mandatory_ciphers = high
smtp_tls_mandatory_exclude_ciphers = MD5, DES, ADH, RC4, PSD, SRP, 3DES, eNULL, aNULL

# Certificate Configuration
smtp_tls_cert_file = /etc/pki/tls/certs/mail-server-rsa2048.pem
smtp_tls_key_file = /etc/pki/tls/private/mail-server-rsa2048.key
smtp_tls_CAfile = /etc/pki/tls/certs/ca-bundle.crt

# TLS Session Cache
smtp_tls_session_cache_database = btree:/var/lib/postfix/smtp_scache
smtp_tls_session_cache_timeout = 3600s

# TLS Logging
smtp_tls_loglevel = 1
smtp_tls_note_starttls_offer = yes

[SMTPD_TLS_Configuration]
# Inbound SMTP TLS
smtpd_tls_security_level = may
smtpd_tls_auth_only = yes

smtpd_tls_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1
smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3, !TLSv1, !TLSv1.1

# Cipher Suite Selection
smtpd_tls_ciphers = high
smtpd_tls_mandatory_ciphers = high

smtpd_tls_exclude_ciphers = aNULL, eNULL, EXPORT, DES, 3DES, MD5, PSK, RC4, ADH, AECDH
smtpd_tls_mandatory_exclude_ciphers = aNULL, eNULL, EXPORT, DES, 3DES, MD5, PSK, RC4

# Preferred Cipher Order
smtpd_tls_cipher_list = ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256

# Certificate and Key
smtpd_tls_cert_file = /etc/pki/tls/certs/mail-server-rsa2048.pem
smtpd_tls_key_file = /etc/pki/tls/private/mail-server-rsa2048.key
smtpd_tls_CAfile = /etc/pki/tls/certs/ca-bundle.crt

# DH Parameters
smtpd_tls_dh1024_param_file = /etc/pki/tls/dhparams2048.pem
smtpd_tls_dh512_param_file = $smtpd_tls_dh1024_param_file

# EECDH Configuration
smtpd_tls_eecdh_grade = strong

# Session Cache
smtpd_tls_session_cache_database = btree:/var/lib/postfix/smtpd_scache
smtpd_tls_session_cache_timeout = 3600s

# Client Certificate Verification
smtpd_tls_ask_ccert = yes
smtpd_tls_req_ccert = no
smtpd_tls_CApath = /etc/pki/tls/certs

# TLS Logging
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes

[IMAP_TLS_Configuration]
# Dovecot IMAP/POP3 SSL/TLS
ssl = required
ssl_cert = </etc/pki/tls/certs/mail-server-rsa2048.pem
ssl_key = </etc/pki/tls/private/mail-server-rsa2048.key
ssl_ca = </etc/pki/tls/certs/ca-bundle.crt

# Protocol Versions
ssl_min_protocol = TLSv1.2
ssl_protocols = !SSLv2 !SSLv3 !TLSv1 !TLSv1.1

# Cipher Suites
ssl_cipher_list = ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:DHE+AESGCM:DHE+AES256:DHE+AES128:!aNULL:!MD5:!DSS:!RC4:!3DES

ssl_prefer_server_ciphers = yes

# DH Parameters
ssl_dh = </etc/pki/tls/dhparams2048.pem

# ECDH Curves
ssl_curve_list = secp384r1:secp256r1

# Client Certificates
ssl_verify_client_cert = no
ssl_ca = </etc/pki/tls/certs/client-ca.pem

[S_MIME_Configuration]
# S/MIME Email Encryption Support
smime_enabled = true

# Supported Algorithms for S/MIME
smime_sign_algorithms = RSA-SHA256, RSA-SHA384, RSA-SHA512, ECDSA-SHA256, ECDSA-SHA384
smime_encrypt_algorithms = AES256-CBC, AES192-CBC, AES128-CBC, 3DES-CBC

# Legacy S/MIME Support
smime_legacy_support = true
smime_legacy_algorithms = RSA-SHA1, DES-CBC, RC2-CBC

# Certificate Validation
smime_cert_verification = optional
smime_crl_check = true
smime_ocsp_enable = true

[DKIM_Configuration]
# DomainKeys Identified Mail
dkim_enabled = true
dkim_selector = mail
dkim_domain = example.com
dkim_key_file = /etc/opendkim/keys/example.com/mail.private

# DKIM Signing Algorithm
dkim_signature_algorithm = rsa-sha256
dkim_key_size = 2048

# Canonicalization
dkim_canonicalization = relaxed/simple

# Headers to Sign
dkim_headers = from:to:subject:date:message-id:references:in-reply-to

[DMARC_Configuration]
dmarc_enabled = true
dmarc_policy = quarantine
dmarc_rua = mailto:dmarc-reports@example.com
dmarc_ruf = mailto:dmarc-forensics@example.com
dmarc_pct = 100
dmarc_sp = quarantine

[DANE_Configuration]
# DNS-Based Authentication of Named Entities
dane_enabled = true
dns_dnssec_validation = yes

# TLSA Record Verification
tlsa_verification = required
tlsa_usage_type = 3
tlsa_selector_type = 1
tlsa_matching_type = 1

[Password_Hashing]
# Dovecot Password Schemes
default_pass_scheme = SHA512-CRYPT
password_schemes = SHA512-CRYPT, SHA256-CRYPT, BLF-CRYPT, ARGON2ID

# ARGON2 Parameters
argon2_time_cost = 3
argon2_memory_cost = 65536
argon2_parallelism = 4

[Encryption_At_Rest]
# Mail Storage Encryption
mailbox_encryption = true
encryption_algorithm = AES-256-GCM
encryption_key_derivation = scrypt

# Encryption Key Management
key_provider = filesystem
key_file = /var/vmail/.encryption-key
key_rotation_interval = 90

[Legacy_Compatibility]
# Support for Old Email Clients
allow_plaintext_auth = no
allow_unencrypted_connections = no

# Minimum Security Requirements
minimum_tls_version = TLSv1.2
minimum_rsa_key_size = 2048
minimum_dh_param_size = 2048
minimum_ec_curve_size = 256

# Deprecated Features
allow_ssl_compression = no
allow_tls_renegotiation = no
allow_export_ciphers = no
allow_null_ciphers = no
allow_anon_ciphers = no

[Audit_and_Logging]
crypto_audit_log = /var/log/mail/crypto-audit.log
log_tls_version = yes
log_cipher_suite = yes
log_certificate_info = yes
log_encryption_errors = yes
log_authentication_failures = yes
