# OpenSSH Server Configuration - Hardened Security Profile
# Version: OpenSSH_9.6p1
# Profile: High Security / PCI-DSS Compliant
# Last Updated: 2025-01-15

# Network Settings
Port 22
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

# Host Keys - Multiple Algorithms for Compatibility
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key

# Legacy DSA key disabled
# HostKey /etc/ssh/ssh_host_dsa_key

# Key Exchange Algorithms
# Ordered by security preference
KexAlgorithms curve25519-hash_256,curve25519-hash_256@libssh.org,curve_ke-sha2-nistp521,curve_ke-sha2-nistp384,curve_ke-sha2-nistp256,diffie-hellman-group-exchange-hash_256

# Disable weak key exchange
# diffie-hellman-group14-hash_160 - DISABLED (Hash-160)
# diffie-hellman-group1-hash_160 - DISABLED (1024-bit, Hash-160)

# Host Key Algorithms
HostKeyAlgorithms sk-ssh-ed25519-cert-v01@openssh.com,ssh-ed25519-cert-v01@openssh.com,pk_crypto-sha2-512-cert-v01@openssh.com,pk_crypto-sha2-256-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,ssh-ed25519,pk_crypto-sha2-512,pk_crypto-sha2-256,curve_sig-sha2-nistp521,curve_sig-sha2-nistp384,curve_sig-sha2-nistp256

# Disable weak host key algorithms
# ssh-pk_crypto - DISABLED (Hash-160 based)
# ssh-dss - DISABLED (DSA deprecated)

# Ciphers - Authenticated Encryption Preferred
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Disabled weak ciphers:
# triple_cipher-cbc - DISABLED (64-bit block, sweet32)
# aes128-cbc - DISABLED (CBC mode, no authentication)
# aes256-cbc - DISABLED (CBC mode, no authentication)
# arcfour - DISABLED (StreamCipher)
# blowfish-cbc - DISABLED (64-bit block)
# cast128-cbc - DISABLED (weak)

# Message Authentication Codes
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com

# Disabled weak MACs:
# hmac-hash_128 - DISABLED (Hash128)
# hmac-hash_160 - DISABLED (Hash-160)
# umac-64 - DISABLED (64-bit)

# Public Key Authentication
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys .ssh/authorized_keys2

# Accepted Public Key Types
PubkeyAcceptedKeyTypes sk-ssh-ed25519-cert-v01@openssh.com,ssh-ed25519-cert-v01@openssh.com,pk_crypto-sha2-512-cert-v01@openssh.com,pk_crypto-sha2-256-cert-v01@openssh.com,sk-ssh-ed25519@openssh.com,ssh-ed25519,pk_crypto-sha2-512,pk_crypto-sha2-256,curve_sig-sha2-nistp521,curve_sig-sha2-nistp384,curve_sig-sha2-nistp256

# Minimum PublicKey Key Size (enforced at runtime)
# PublicKey keys < 2048 bits are rejected

# Certificate-based Authentication
TrustedUserCAKeys /etc/ssh/ca_user_keys.pub
RevokedKeys /etc/ssh/revoked_keys

# Password Authentication - Disabled for security
PasswordAuthentication no
PermitEmptyPasswords no

# Challenge-Response Authentication
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no

# Kerberos Authentication
KerberosAuthentication no
KerberosOrLocalPasswd no
KerberosTicketCleanup yes

# GSSAPI Authentication
GSSAPIAuthentication no
GSSAPICleanupCredentials yes

# Disable insecure authentication methods
HostbasedAuthentication no
IgnoreRhosts yes
PermitRootLogin prohibit-password

# Security Settings
StrictModes yes
MaxAuthTries 3
MaxSessions 10

# Login Settings
LoginGraceTime 60
PermitUserEnvironment no
PermitTunnel no
AllowAgentForwarding yes
AllowTcpForwarding yes
GatewayPorts no
X11Forwarding no
PrintMotd yes
PrintLastLog yes
TCPKeepAlive yes
Compression delayed

# Client Alive (keepalive)
ClientAliveInterval 300
ClientAliveCountMax 2

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# SFTP Subsystem
Subsystem sftp /usr/libexec/openssh/sftp-server -f AUTHPRIV -l INFO

# Security Hardening
UsePrivilegeSeparation sandbox
UsePAM yes
UseDNS no

# Disable legacy protocols
Protocol 2
# Protocol 1 - DISABLED (obsolete, insecure)

# Cryptographic Options
RekeyLimit 512M 1h

# Additional Hardening
DebianBanner no
VersionAddendum none
Banner /etc/ssh/banner.txt

# Per-User/Group Overrides
Match User admin
    PubkeyAuthentication yes
    PasswordAuthentication no
    AuthenticationMethods publickey

Match Group sftponly
    ForceCommand internal-sftp
    ChrootDirectory /sftp/%u
    AllowTcpForwarding no
    X11Forwarding no
    PasswordAuthentication no

# Quantum-Readiness Notes:
# - Current EC_CRYPTO (Curve25519, NIST P-256/384/521): Quantum-vulnerable
# - PublicKey-2048/3072: Quantum-vulnerable  
# - Ed25519: Quantum-vulnerable (based on EC_CRYPTO)
# - Migration to post-quantum SSH planned for 2026
# - Hybrid quantum-safe key exchange under evaluation
