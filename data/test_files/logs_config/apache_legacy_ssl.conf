# Apache Web Server SSL/TLS Configuration
# Server: Production Web Server (legacy compatibility mode)
# Last Modified: 2024-12-15

LoadModule ssl_module modules/mod_ssl.so

Listen 443

SSLPassPhraseDialog builtin
SSLSessionCache shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout 300

SSLRandomSeed startup file:/dev/urandom 256
SSLRandomSeed connect builtin

SSLCryptoDevice builtin

<VirtualHost *:443>
    ServerName www.legacy-app.com
    ServerAdmin admin@legacy-app.com
    DocumentRoot /var/www/html

    SSLEngine on

    # Certificate Configuration
    SSLCertificateFile /etc/pki/tls/certs/server.crt
    SSLCertificateKeyFile /etc/pki/tls/private/server.key
    SSLCertificateChainFile /etc/pki/tls/certs/intermediate.crt

    # SSL Protocol Configuration
    SSLProtocol all -SSLv2 -SSLv3
    # Allows: TLSv1.0, TLSv1.1, TLSv1.2, TLSv1.3

    # Cipher Suite Configuration - Broad compatibility
    SSLCipherSuite HIGH:MEDIUM:+3DES:+RC4:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!SRP
    SSLHonorCipherOrder on

    # Support for legacy clients
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:RC4-SHA:DES-CBC3-SHA

    # DH Parameters for DHE cipher suites
    SSLOpenSSLConfCmd DHParameters /etc/pki/tls/dhparam1024.pem

    # ECDH Curve Configuration
    SSLOpenSSLConfCmd Curves secp256r1:secp384r1:prime256v1

    # Enable insecure renegotiation for old clients
    SSLInsecureRenegotiation on
    SSLCompression off

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # Client Certificate Authentication (optional)
    SSLVerifyClient optional
    SSLVerifyDepth 2
    SSLCACertificateFile /etc/pki/tls/certs/ca-bundle.crt
    SSLOptions +StdEnvVars +ExportCertData

    # HTTP Strict Transport Security
    Header always set Strict-Transport-Security "max-age=15768000"

    <Directory /var/www/html>
        SSLRequireSSL
        SSLOptions +StdEnvVars
        AllowOverride All
        Require all granted
    </Directory>

    # CGI Scripts
    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>

    # Logging
    ErrorLog logs/ssl_error_log
    TransferLog logs/ssl_access_log
    LogLevel warn

    CustomLog logs/ssl_request_log \
          "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"

</VirtualHost>

<VirtualHost *:443>
    ServerName api.legacy-app.com

    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/api-server-rsa1024.crt
    SSLCertificateKeyFile /etc/pki/tls/private/api-server-rsa1024.key

    # API Server - More permissive for mobile app compatibility
    SSLProtocol all -SSLv2
    # Allows: SSLv3, TLSv1.0, TLSv1.1, TLSv1.2, TLSv1.3

    SSLCipherSuite ALL:!aNULL:!eNULL:!EXPORT40:!EXPORT56:+HIGH:+MEDIUM:+LOW:+RC4:+MD5

    # Explicitly enable weak ciphers for legacy mobile apps
    SSLCipherSuite RC4-SHA:RC4-MD5:DES-CBC-SHA:DES-CBC3-SHA:AES128-SHA:AES256-SHA:ECDHE-RSA-RC4-SHA:DHE-RSA-AES128-SHA

    SSLOpenSSLConfCmd SignatureAlgorithms RSA+SHA1:RSA+SHA256:RSA+MD5:ECDSA+SHA1

    # Disable security features for compatibility
    SSLHonorCipherOrder off
    SSLInsecureRenegotiation on
    SSLCompression on

    <Location /api/v1>
        SSLRequireSSL
        SSLVerifyClient none
    </Location>
</VirtualHost>

# OCSP Stapling Cache
SSLStaplingCache shmcb:/var/run/ocsp(128000)

# Session Tickets
SSLSessionTickets on
